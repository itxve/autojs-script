<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>

  <style>
    /* ç®€çº¦åœ†è§’è¾¹æ¡† */
    .img-border-1 {
      border: 3px solid #f0f0f0;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }

    /* æ¸å˜å‘å…‰è¾¹æ¡† */
    .img-border-2 {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
    }

    .img-border-2::before {
      content: '';
      position: absolute;
      inset: -2px;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      z-index: -1;
      filter: blur(8px);
    }

    /* ç«‹ä½“æµ®é›•è¾¹æ¡† */
    .img-border-3 {
      border: 1px solid #ffffff;
      box-shadow:
        12px 12px 16px rgba(0, 0, 0, 0.1),
        inset 2px 2px 4px rgba(255, 255, 255, 0.5),
        inset -2px -2px 4px rgba(0, 0, 0, 0.1);
      border-radius: 4px;
      background: #f8f9fa;
      padding: 8px;
    }

    /* æ‚¬æµ®åŠ¨ç”»è¾¹æ¡† */
    .img-border-hover {
      border: 2px solid transparent;
      border-radius: 16px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .img-border-hover:hover {
      border-color: #7c3aed;
      box-shadow: 0 10px 20px -5px rgba(124, 58, 237, 0.3);
      transform: translateY(-4px);
    }

    /* å¤å¤ç›¸æ¡†æ•ˆæœ */
    .vintage-frame {
      padding: 12px;
      background: #f4e9d8;
      border: 8px double #8b4513;
      box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    .vintage-frame::after {
      content: '';
      position: absolute;
      top: 5px;
      left: 5px;
      right: 5px;
      bottom: 5px;
      border: 1px solid rgba(139, 69, 19, 0.3);
    }
  </style>
</head>

<body>
  <div style="display: flex;flex-direction: row;">
    <div style="flex: 1; ">
      <input id="wss_location" value="192.168.10.21:8080" placeholder="è¯·è¾“å…¥wsåœ°å€" />
      <button onclick="connect()">è¿æ¥æœåŠ¡å™¨</button>
      <button onclick="sendMessage()">æ‰§è¡Œä»£ç </button>
      <div><textarea style="width: 88%;" id="code" rows="5"></textarea></div>
      <div id="status">çŠ¶æ€: æœªè¿æ¥</div>
      <div id="messages"></div>
    </div>
    <div style="flex: 4; ">
      <div>å±å¹•ğŸ–¥</div>
      <img alt="åŠ è½½å¤±è´¥" id="img" class="img-border-1" />
    </div>
  </div>

  <script>

    const ipPortRegex =
      /^((?:25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9]{2}|[1-9]?[0-9])(?::(?:[0-9]{1,4}|[1-5][0-9]{4}|6[0-4][0-9]{3}|65[0-4][0-9]{2}|655[0-2][0-9]|6553[0-5]))?$/;


    let web_img_ws;
    // è¿æ¥ WebSocket æœåŠ¡å™¨
    function connect() {
      let wss_location = document.querySelector("#wss_location").value;
      if (!ipPortRegex.test(wss_location)) {
        alert("wsåœ°å€é”™è¯¯");
        return
      }

      web_img_ws = newSocket(wss_location, "web_img", (event) => showImg(event.data));
    }

    function newSocket(wss_location, clientId, onMessage) {
      let ws = new WebSocket(`ws://${wss_location}/ws?device=` + JSON.stringify({
        clientId: clientId
      })); // æ›¿æ¢ä¸ºä½ çš„æœåŠ¡ç«¯åœ°å€

      // ç›‘å¬è¿æ¥æ‰“å¼€
      ws.onopen = () => {
        updateStatus(clientId + ':å·²è¿æ¥');
        logMessage(clientId + ':æˆåŠŸè¿æ¥åˆ°æœåŠ¡å™¨');
      };

      // æ¥æ”¶æ–‡æœ¬æ¶ˆæ¯
      ws.onmessage = (event) => {
        onMessage(event)
      };

      // é”™è¯¯å¤„ç†
      ws.onerror = (error) => {
        updateStatus(clientId + ':è¿æ¥é”™è¯¯');
        console.error(clientId + ':WebSocket é”™è¯¯:', error);
      };

      // ç›‘å¬è¿æ¥å…³é—­
      ws.onclose = () => {
        updateStatus(clientId + ':å·²æ–­å¼€');
        logMessage(clientId + ':è¿æ¥å·²å…³é—­');
      };
      return ws;
    }

    // å‘é€æ–‡æœ¬æ¶ˆæ¯
    function sendMessage() {

      if (web_img_ws && web_img_ws.readyState === WebSocket.OPEN) {
        console.log('web_img_ws', { code: document.getElementById('code').value || "toast('hello!');" });

        web_img_ws.send(JSON.stringify({ code: document.getElementById('code').value || "toast('hello!');" }))
      }
    }


    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatus(text) {
      document.getElementById('status').textContent = `çŠ¶æ€: ${text}`;
    }

    // è®°å½•æ¶ˆæ¯åˆ°ç•Œé¢
    function logMessage(msg) {
      const div = document.createElement('div');
      div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      document.getElementById('messages').appendChild(div);
    }


    let _url;
    function showImg(data) {
      if (data instanceof Blob) {
        if (_url) {
          URL.revokeObjectURL(_url)
        }
        const url = URL.createObjectURL(data);
        _url = url
        img.src = url;
        document.getElementById('img').setAttribute("src", url
        )
      }
    }
  </script>

</html>